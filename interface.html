<!DOCTYPE html>
<html>
<head>
    <title>Ollama LangChain WebSocket</title>

    <!-- â­ Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Link to themes -->
    <link rel="stylesheet" href="/themes.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Table Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        thead {
            background: var(--bg-secondary);
        }

        th, td {
            padding: 10px 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        th {
            font-weight: bold;
            color: var(--color-system);
        }

        tr:hover {
            background: var(--bg-hover);
        }

        tbody tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        body {
            font-family: 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        #header {
            background: var(--bg-secondary);
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        #model-select, button, #theme-select {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-width);
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        button:hover:not(:disabled), #model-select:hover, #theme-select:hover {
            background: var(--bg-hover);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #status {
            margin-left: auto;
            color: var(--text-secondary);
        }
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-chat);
        }
        .message {
            margin: 15px 0;
            line-height: 1.6;
        }
        .assistant { color: var(--color-assistant); }
        .user { color: var(--color-user); }
        .system { color: var(--color-system); }
        .error { color: var(--color-error); }

        pre, code {
            background: var(--code-bg) !important;
            color: var(--code-text) !important;
            padding: 6px;
            border-radius: 4px;
            overflow-x: auto;
        }

        #input-area {
            display: flex;
            padding: 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }
        #input {
            flex: 1;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-width);
            padding: 10px;
            border-radius: 3px;
            resize: none;
            font-family: inherit;
        }
    </style>
</head>
<body>

    <div id="header">
        <select id="theme-select">
            <option value="default">Default Dark</option>
            <option value="dracula">Dracula</option>
            <option value="monokai">Monokai</option>
            <option value="nord">Nord</option>
            <option value="gruvbox">Gruvbox</option>
            <option value="solarized">Solarized Dark</option>
            <option value="tokyo">Tokyo Night</option>
            <option value="cyberpunk">Cyberpunk</option>
            <option value="matrix">Matrix</option>
        </select>
        <select id="model-select">
            <option value="">Select a model...</option>
        </select>
        <button id="connect-btn">Connect</button>
        <div id="status">Disconnected</div>
    </div>

    <div id="chat"></div>

    <div id="input-area">
        <textarea id="input" rows="2" placeholder="Type your message..." disabled></textarea>
        <button id="send-btn" disabled>Send</button>
    </div>

<script>
let ws = null;
let currentMessage = null;

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send-btn');
const connectBtn = document.getElementById('connect-btn');
const modelSelect = document.getElementById('model-select');
const themeSelect = document.getElementById('theme-select');
const status = document.getElementById('status');

// -------------------------------
// Theme Management
// -------------------------------

function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'default';
    themeSelect.value = savedTheme;
    applyTheme(savedTheme);
}

function applyTheme(theme) {
    if (theme === 'default') {
        document.documentElement.removeAttribute('data-theme');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
    }
    localStorage.setItem('theme', theme);
}

themeSelect.addEventListener('change', (e) => {
    applyTheme(e.target.value);
});

// -------------------------------
// Markdown Rendering Chat Function
// -------------------------------

function addMessage(type, content) {
    const div = document.createElement('div');
    div.className = `message ${type}`;

    let prefix = "";
    if (type === "user") prefix = "**You:**\n\n";
    else if (type === "assistant") prefix = `**${modelSelect.value}:**\n\n`;
    else if (type === "system") prefix = "**System:**\n\n";

    const md = prefix + content;
    div.dataset.raw = md;
    div.innerHTML = marked.parse(md);

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
}

// ------------------------------

async function loadModels() {
    try {
        const response = await fetch('/models');
        const data = await response.json();
        data.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            modelSelect.appendChild(option);
        });
    } catch (e) {
        console.error('Failed to load models:', e);
    }
}

connectBtn.addEventListener('click', () => {
    const model = modelSelect.value;
    if (!model) return;

    if (ws) ws.close();

    ws = new WebSocket(`ws://localhost:8000/ws/${model}`);

    ws.onopen = () => {
        status.textContent = `Connected: ${model}`;
        status.style.color = 'var(--color-assistant)';
        input.disabled = false;
        sendBtn.disabled = false;
        connectBtn.textContent = 'Reconnect';
        addMessage('system', `Connecting to ${model}...`);
        currentMessage = addMessage('assistant', '');
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'token') {
            if (currentMessage) {
                currentMessage.dataset.raw += data.content;
                currentMessage.innerHTML = marked.parse(currentMessage.dataset.raw);
                chat.scrollTop = chat.scrollHeight;
            }
        } else if (data.type === 'start') {
            currentMessage = addMessage('assistant', '');
        } else if (data.type === 'end') {
            currentMessage = null;
        } else if (data.type === 'error') {
            addMessage('error', data.content);
        } else if (data.type === 'system') {
            addMessage('system', data.content);
        }
    };

    ws.onerror = () => {
        addMessage('error', 'WebSocket error');
        status.textContent = 'Error';
        status.style.color = 'var(--color-error)';
    };

    ws.onclose = () => {
        status.textContent = 'Disconnected';
        status.style.color = 'var(--text-secondary)';
        input.disabled = true;
        sendBtn.disabled = true;
    };
});

sendBtn.addEventListener('click', () => {
    const message = input.value.trim();
    if (!message || !ws) return;

    addMessage('user', message);
    ws.send(JSON.stringify({ type: "message", content: message }));
    input.value = '';
});

input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
    }
});

// Initialize
loadTheme();
loadModels();
</script>

</body>
</html>